name: Zip Including Dependencies

on: [push]
jobs:
  Produce-Dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: get_converted_repo_name
        run: |
          CONVERTED_REPO_NAME="$(echo "${{ github.repository }}" | sed 's/\//_/g')"
          echo "CONVERTED_REPO_NAME=$CONVERTED_REPO_NAME" >> $GITHUB_OUTPUT
      - run: python --version
      - run: pwd
      - run: ls -larth
      - run: python -m venv ./dependencies
      - run: source ./dependencies/bin/activate
      - run: python -m pip install -r requirements.txt
      - run: rm -rf dist
      - run: mkdir -p dist
      - run: zip -q -r -s 5m "dist/${{ steps.get_converted_repo_name.outputs.CONVERTED_REPO_NAME }}.zip" *
      - name: Get current date
        id: get_current_date
        run: |
          NOW="$(date "+%Y-%m-%d_%H-%M-%S")"
          echo "CURRENT_DATE=$NOW" >> $GITHUB_OUTPUT
      - run: echo $TAG_NAME
        env:
          TAG_NAME: nightly-tag-${{ steps.get_current_date.outputs.CURRENT_DATE }}

      - name: Move files to temp dirs
        run: |
          find dist/* -type f -maxdepth 1 \
          -exec sh -c 'cp "$0" "./output/${0##*/}"' {} \;

      - name: Upload Individual Artifacts
        run: |
          cd output || exit

          for filename in */ ; do
              base=${filename%%.*};

              echo "Uploading $base..."
              actions/upload-artifact@v3 \
                  --name="$base" \
                  --path="./$filename"
          done

      - name: Clean up temp dirs
        run: rm -rf tmp/






      # - uses: actions/upload-artifact@v4
      #   with:
      #     name: ${{ steps.get_converted_repo_name.outputs.CONVERTED_REPO_NAME }}_archive_${{ steps.get_current_date.outputs.CURRENT_DATE }}
      #     path: dist/
      #     retention-days: 7
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}"
