name: Zip Including Dependencies

on: [push]
jobs:
  Produce-Dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: get_converted_repo_name
        run: |
          CONVERTED_REPO_NAME="$(echo "${{ github.repository }}" | sed 's/\//_/g')"
          echo "CONVERTED_REPO_NAME=$CONVERTED_REPO_NAME" >> $GITHUB_OUTPUT
      - run: python --version
      - run: pwd
      - run: ls -larth
      - run: python -m venv ./dependencies
      - run: source ./dependencies/bin/activate
      - run: python -m pip install -r requirements.txt
      - run: rm -rf dist
      - run: mkdir -p dist
      - run: zip -q -r -s 5m "dist/${{ steps.get_converted_repo_name.outputs.CONVERTED_REPO_NAME }}.zip" *
      - name: Get current date
        id: get_current_date
        run: |
          NOW="$(date "+%Y-%m-%d_%H-%M-%S")"
          echo "CURRENT_DATE=$NOW" >> $GITHUB_OUTPUT
      - run: mkdir -p output && ls -larth output

      - name: Find Files in Source Dir
        id: find-files
        run: |
          echo ::set-output name=FILES::$(find dist/* -type f -print0 | xargs -0 printf '%q\n')

      - name: Iterate & Upload Artifacts
        env:
          FILES: ${{ steps.find-files.outputs.FILES }}
        run: |
          set -x
          for file in $(echo "$FILES"); do
            echo "Uploading '$file'"

            # Replace '<desired-prefix>' below with whatever prefix you prefer
            dest="${file/$PWD\/</prefix/}"
            echo "Dest $(basename $dest)"

            gh workflow run actions/upload-artifact@v3 \
              --name=$(basename "$dest") \
              --path="$file"
          done

      - name: Clean up temp dirs
        run: rm -rf tmp/

      # - uses: actions/upload-artifact@v4
      #   with:
      #     name: ${{ steps.get_converted_repo_name.outputs.CONVERTED_REPO_NAME }}_archive_${{ steps.get_current_date.outputs.CURRENT_DATE }}
      #     path: dist/
      #     retention-days: 7
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}"
      - uses: actions/setup-node@v4
        with:
          node-version: '20.11.1'


